<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>stemsplat setup</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg-1:#0F2027; --bg-2:#2C5364; --txt:#E7ECEF; --accent:#8ED8FF; --card:rgba(23,35,41,.55); --border:rgba(255,255,255,.06); }
    html, body { background-color: #0B1A1F; }
    body{ background: linear-gradient(135deg,#0B1A1F 0%, var(--bg-1) 35%, var(--bg-2) 100%); color:var(--txt); font-family:'Nunito Sans',system-ui,sans-serif; }
    @view-transition { navigation: auto; }
    .noise::before { content: ""; position: fixed; inset: 0; pointer-events: none; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.035"/></svg>') repeat; opacity:.18; }
    .shade { position: fixed; inset: 0; pointer-events: none; background: rgba(0,0,0,0.24); z-index: -1; }
    .glass{ background:var(--card); backdrop-filter:blur(18px) saturate(120%); -webkit-backdrop-filter:blur(18px) saturate(120%); border:1px solid var(--border); box-shadow:0 12px 40px rgba(0,0,0,.35); }
    .sheen{ position:relative; isolation:isolate; border-radius:18px; }
    .sheen::before{ content:""; position:absolute; inset:0; padding:1px; border-radius:inherit; background:conic-gradient(from 0deg, var(--accent), transparent 30%, var(--accent), transparent 60%, var(--accent)); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; opacity:.28; }
    .fade-out{ opacity:0; transition: opacity .28s ease; }
    .fade-in{ animation:fade .6s ease both; }
    @keyframes fade{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
    .fade-shell{ transition: opacity .35s ease; }
    .fade-shell.fade-out{ opacity:0; }
    .spin{
      width:18px; height:18px; border-radius:999px;
      border:3px solid rgba(255,255,255,.14);
      border-top-color:var(--accent);
      border-right-color:rgba(142,216,255,.65);
      box-shadow: 0 0 0 1px rgba(11,26,31,.35) inset;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center gap-14">
  <div class="noise fixed inset-0 -z-10"></div>
  <div class="shade"></div>
  <div id="installer-shell" class="fade-shell">
    <h1 class="text-4xl md:text-5xl font-light fade-in select-none">stemsplat setup</h1>
    <div id="card" class="sheen glass w-11/12 max-w-xl px-8 py-6 rounded-2xl flex flex-col gap-4 fade-in mt-2">
      <div class="flex items-center gap-3">
        <span id="status">starting…</span>
        <div id="spinner" class="spin" aria-hidden="true"></div>
      </div>
      <div id="note" class="opacity-70 text-sm">this might take a minute (it'll probably take way less)</div>
      <div id="error" class="hidden text-red-300 text-sm"></div>
    </div>
  </div>
  <div id="loading" class="hidden">starting server…</div>

  <script>
    let launched = false;
    let pingTimer = null;
    let mainAlreadyRunning = false;
    let downloadPopupOpen = false;
    let downloadPopupClosed = false;
    let pendingLaunch = false;
    const hasInstalledBefore = localStorage.getItem('installedOnce') === '1';
    const noteOnce = document.getElementById('note');
    if(hasInstalledBefore && noteOnce){ noteOnce.classList.add('hidden'); }

    function startPinging(){
      if (!pingTimer) { pingTimer = setInterval(pingMainServer, 900); }
    }

    async function poll(){
      const res = await fetch('/progress');
      const data = await res.json();
      const status = document.getElementById('status');
      const spinner = document.getElementById('spinner');
      const note = document.getElementById('note');
      const err = document.getElementById('error');

      if (status) {
        status.textContent = data.pct < 100 && data.pct !== -1
          ? 'installing prerequisites. This may take a minute or two.'
          : 'checking…';
      }
      if(spinner){ spinner.classList.toggle('hidden', data.pct >= 100 || data.pct === -1); }
      if(data.pct === -1){
        err.textContent = data.error || 'installation failed';
        err.classList.remove('hidden');
        return;
      }
      if(data.main_running){
        mainAlreadyRunning = true;
      }
      if (data.pct >= 100) {
        localStorage.setItem('installedOnce','1');
        if(note){ note.classList.add('hidden'); }
      }
      const missingModels = Array.isArray(data.models_missing) ? data.models_missing : [];
      if (missingModels.length > 0) {
        showDownloadPopup();
      }
      startPinging();
      if(data.pct >= 100){
        if(!downloadPopupOpen || downloadPopupClosed){
          waitForServer();
        }else{
          pendingLaunch = true;
        }
        return;
      }
      setTimeout(poll, 1000);
    }

    function showDownloadPopup(){
      if(downloadPopupOpen || downloadPopupClosed) return;
      downloadPopupOpen = true;
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 grid place-items-center backdrop-blur-sm';
      overlay.innerHTML = `<div class="sheen glass p-6 rounded-2xl flex flex-col gap-4 max-w-lg w-full">
        <h2 class="text-2xl font-light">Download Models</h2>
        <p class="text-sm opacity-80">Download these models and place them in the Stemsplat/Models folder. The download links are also available in the <a class="underline" href="https://github.com/Skytheredhead/stemsplat" target="_blank" rel="noopener noreferrer">Github</a>.</p>
        <ul class="list-disc list-inside text-sm opacity-90">
          <li><a class="underline" href="https://huggingface.co/becruily/mel-band-roformer-vocals/resolve/main/mel_band_roformer_vocals_becruily.ckpt?download=true" target="_blank" rel="noopener noreferrer">Mel Band Roformer Vocals</a></li>
          <li><a class="underline" href="https://huggingface.co/becruily/mel-band-roformer-instrumental/resolve/main/mel_band_roformer_instrumental_becruily.ckpt?download=true" target="_blank" rel="noopener noreferrer">Mel Band Roformer Instrumental</a></li>
          <li><a class="underline" href="https://huggingface.co/becruily/mel-band-roformer-deux/resolve/main/becruily_deux.ckpt?download=true" target="_blank" rel="noopener noreferrer">Becruily Deux</a></li>
        </ul>
        <div class="flex justify-end">
          <button id="close-models" class="px-4 py-1 rounded-lg bg-white/90 text-gray-900">close</button>
        </div>
      </div>`;
      document.body.appendChild(overlay);
      const closeBtn = overlay.querySelector('#close-models');
      closeBtn.onclick = () => {
        downloadPopupOpen = false;
        downloadPopupClosed = true;
        overlay.remove();
        if(pendingLaunch){
          pendingLaunch = false;
          waitForServer();
        }
      };
      overlay.tabIndex = 0;
      overlay.focus();
    }

    async function pingMainServer(){
      if (launched) return;
      try{
        await fetch('http://localhost:8000/', {mode:'no-cors'});
        await launchApp();
      }catch(_){ }
    }

    async function waitForServer(){
      startPinging();
      await pingMainServer();
    }

    async function launchApp(){
      if (launched) return;
      launched = true;
      if (pingTimer) { clearInterval(pingTimer); }
      const card = document.getElementById('card');
      const loading = document.getElementById('loading');
      // start a quick fade-out and cue the intro for the app page
      const shell = document.getElementById('installer-shell');
      if(shell){ shell.classList.add('fade-out'); }
      card.style.animation = 'fade .4s ease reverse both';
      loading.classList.remove('hidden');
      // ensure the fade is visible before navigating
      await new Promise(r=>setTimeout(r,260));
      localStorage.setItem('playIntro','1');
      try { navigator.sendBeacon('http://localhost:6060/installer_shutdown'); } catch(_) {
        try { fetch('http://localhost:6060/installer_shutdown', { method:'POST', mode:'no-cors', keepalive:true }); } catch(_){}
      }
      const target = mainAlreadyRunning ? 'http://localhost:8000/?reopen=1' : 'http://localhost:8000/';
      location.replace(target);
    }
    startPinging();
    poll();
  </script>
</body>
</html>
